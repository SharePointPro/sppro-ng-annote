import { Component, EventEmitter, Output } from '@angular/core';
import Konva from 'konva';
import { DrawableEnum } from '../enums/drawableEnum';
import shapeFactory from '../factories/shapeFactory';
import textareaFactory from '../factories/textareaFactory';
const DEFAULT_DRAWABLE_TYPE = DrawableEnum.FreePathDrawable;
const DEFAULT_FONT_FAMILY = 'Arial';
export class NgAnnoteComponent {
    constructor() {
        this.onSave = new EventEmitter();
        this._drawableType = DEFAULT_DRAWABLE_TYPE;
        this.isPaint = false;
        this.mode = 'brush';
        this.color = '#000000';
        this.textAreaVisible = false;
    }
    get drawableType() {
        return this._drawableType;
    }
    set drawableType(value) {
        this._drawableType = value;
    }
    ngOnInit() {
        this.img = new Image();
        this.img.onload = () => {
            this.image = new Konva.Image({
                image: this.img,
            });
            this.initalizeStage();
            this.layer = new Konva.Layer({});
            this.layer.add(this.image);
            this.stage.add(this.layer);
        };
        this.img.src = "https://sharepointpro.github.io/sppro-image-annote/static/media/room.fdc5a868.jpg";
    }
    initalizeStage() {
        this.stage = new Konva.Stage({
            container: "stage",
            width: this.img.width,
            height: this.img.height
        });
        this.stage.on('mousedown', (e) => { this.onMouseDown(e); });
        this.stage.on('mouseup', (e) => { this.onMouseUp(e); });
        this.stage.on('mousemove', (e) => { this.onMouseMove(e); });
    }
    onMouseDown(e) {
        this.isPaint = true;
        var pos = this.stage.getPointerPosition();
        if (this.drawableType === DrawableEnum.FreePathDrawable) {
            this.lastShape = shapeFactory.CreateLine(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.SquareDrawable) {
            this.lastShape = shapeFactory.CreateRectange(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.CircleDrawable) {
            this.lastShape = shapeFactory.CreateCircle(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.ArrowDrawable) {
            this.lastShape = shapeFactory.CreateArrow(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.TextDrawable) {
            if (!this.textAreaVisible) {
                this.textAreaVisible = true;
                textareaFactory.createTextArea(pos.x, pos.y, this.color, DEFAULT_FONT_FAMILY, (element) => {
                    if (element.target.value !== "") {
                        this.lastShape = shapeFactory.CreateText(pos.x, pos.y, this.color, DEFAULT_FONT_FAMILY, element.target.value);
                        this.layer.add(this.lastShape);
                        this.layer.batchDraw();
                        this.textAreaVisible = false;
                    }
                });
            }
        }
    }
    onSaveClick() {
        this.onSave.emit(this.stage.toDataURL());
    }
    onClear() {
        while (this.layer.children.length > 1) {
            this.onUndo();
        }
        this.layer.batchDraw();
    }
    onMouseUp(e) {
        this.isPaint = false;
        this.lastShape = null;
    }
    onUndo() {
        if (this.layer.children.length > 1) {
            this.layer.children.splice(-1, 1);
            this.layer.batchDraw();
        }
    }
    onMouseMove(e) {
        if (!this.isPaint || !this.lastShape || this.lastShape === DrawableEnum.TextDrawable) {
            return;
        }
        const pos = this.stage.getPointerPosition();
        if (this.drawableType === DrawableEnum.FreePathDrawable) {
            let newPoints = this.lastShape.points().concat([pos.x, pos.y]);
            this.lastShape.points(newPoints);
        }
        if (this.drawableType === DrawableEnum.SquareDrawable) {
            const dx = -(this.lastShape.attrs.x - pos.x);
            const dy = -(this.lastShape.attrs.y - pos.y);
            this.lastShape.attrs.width = dx;
            this.lastShape.attrs.height = dy;
        }
        if (this.drawableType === DrawableEnum.CircleDrawable) {
            const dx = this.lastShape.attrs.x - pos.x;
            const dy = this.lastShape.attrs.y - pos.y;
            const radius = Math.sqrt(dx * dx + dy * dy);
            this.lastShape.attrs.radius = radius;
        }
        if (this.drawableType === DrawableEnum.ArrowDrawable) {
            let newPoints = [this.lastShape.attrs.points[0], this.lastShape.attrs.points[1]];
            newPoints.push(pos.x);
            newPoints.push(pos.y);
            this.lastShape.points(newPoints);
        }
        this.layer.batchDraw();
    }
}
NgAnnoteComponent.decorators = [
    { type: Component, args: [{
                selector: 'sppro-ng-annote',
                template: "<div class='overlay sppro-overlay'>\r\n    <sppro-toolbar [(drawableType)]=\"drawableType\" [(color)]=\"color\" (onUndo)=\"onUndo()\" (onClear)=\"onClear()\" (onSave)=\"onSaveClick()\"></sppro-toolbar>\r\n    <div class=\"centeredBox\">\r\n        <div id=\"stage\">\r\n            \r\n        </div>\r\n    </div>\r\n\r\n</div>",
                styles: [".centeredBox{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%)}.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.6);z-index:1000}.closeButton{position:fixed;right:15px;top:15px;cursor:pointer}.crosshair{cursor:crosshair}.text{cursor:text}"]
            },] }
];
NgAnnoteComponent.ctorParameters = () => [];
NgAnnoteComponent.propDecorators = {
    onSave: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctYW5ub3RlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NwcHJvLW5nLWFubm90ZS9zcmMvbGliL25nLWFubm90ZS9uZy1hbm5vdGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFVLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RSxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFPLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sWUFBWSxNQUFNLDJCQUEyQixDQUFDO0FBQ3JELE9BQU8sZUFBZSxNQUFNLDhCQUE4QixDQUFDO0FBRTNELE1BQU0scUJBQXFCLEdBQWlCLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztBQUMxRSxNQUFNLG1CQUFtQixHQUFXLE9BQU8sQ0FBQztBQU81QyxNQUFNLE9BQU8saUJBQWlCO0lBa0I1QjtRQWhCVSxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUV0QyxrQkFBYSxHQUFpQixxQkFBcUIsQ0FBQztRQUs1RCxZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLFNBQUksR0FBVyxPQUFPLENBQUM7UUFFdkIsVUFBSyxHQUFXLFNBQVMsQ0FBQztRQUMxQixvQkFBZSxHQUFZLEtBQUssQ0FBQztJQU9qQyxDQUFDO0lBR0QsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLFlBQVksQ0FBQyxLQUFtQjtRQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztJQUM3QixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUV2QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7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QUNsQztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsY0FBYyxFQUFFO1lBQ3JELE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTdDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztTQUNsQztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsY0FBYyxFQUFFO1lBQ3JELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztTQUN0QztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsYUFBYSxFQUFFO1lBQ3BELElBQUksU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWpGLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXRCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN6QixDQUFDOzs7WUE5S0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxpQkFBaUI7Z0JBQzNCLG9WQUF5Qzs7YUFFMUM7Ozs7cUJBR0UsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZU9mZmxpbmVDb21waWxlVXJsUmVzb2x2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21waWxlcic7XHJcbmltcG9ydCB7IENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBPbkluaXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgS29udmEgZnJvbSAna29udmEnO1xyXG5pbXBvcnQgeyBEcmF3YWJsZUVudW0gfSBmcm9tICAnLi4vZW51bXMvZHJhd2FibGVFbnVtJztcclxuaW1wb3J0IHNoYXBlRmFjdG9yeSBmcm9tICcuLi9mYWN0b3JpZXMvc2hhcGVGYWN0b3J5JztcclxuaW1wb3J0IHRleHRhcmVhRmFjdG9yeSBmcm9tICcuLi9mYWN0b3JpZXMvdGV4dGFyZWFGYWN0b3J5JztcclxuXHJcbmNvbnN0IERFRkFVTFRfRFJBV0FCTEVfVFlQRTogRHJhd2FibGVFbnVtID0gRHJhd2FibGVFbnVtLkZyZWVQYXRoRHJhd2FibGU7XHJcbmNvbnN0IERFRkFVTFRfRk9OVF9GQU1JTFk6IHN0cmluZyA9ICdBcmlhbCc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3NwcHJvLW5nLWFubm90ZScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL25nLWFubm90ZS5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vbmctYW5ub3RlLmNvbXBvbmVudC5zY3NzJ11cclxufSlcclxuZXhwb3J0IGNsYXNzIE5nQW5ub3RlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgQE91dHB1dCgpIG9uU2F2ZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICBwcml2YXRlIF9kcmF3YWJsZVR5cGU6IERyYXdhYmxlRW51bSA9IERFRkFVTFRfRFJBV0FCTEVfVFlQRTtcclxuXHJcbiAgc3RhZ2U6IEtvbnZhLlN0YWdlO1xyXG4gIGxheWVyOiBLb252YS5MYXllcjtcclxuICBpbWFnZTogS29udmEuSW1hZ2U7XHJcbiAgaXNQYWludDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIG1vZGU6IHN0cmluZyA9ICdicnVzaCc7XHJcbiAgbGFzdFNoYXBlOiBhbnk7XHJcbiAgY29sb3I6IHN0cmluZyA9ICcjMDAwMDAwJztcclxuICB0ZXh0QXJlYVZpc2libGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcblxyXG4gIGltZzogSFRNTEltYWdlRWxlbWVudDtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcblxyXG4gIH1cclxuXHJcblxyXG4gIGdldCBkcmF3YWJsZVR5cGUoKTogRHJhd2FibGVFbnVtIHtcclxuICAgIHJldHVybiB0aGlzLl9kcmF3YWJsZVR5cGU7XHJcbiAgfVxyXG5cclxuICBzZXQgZHJhd2FibGVUeXBlKHZhbHVlOiBEcmF3YWJsZUVudW0pIHtcclxuICAgIHRoaXMuX2RyYXdhYmxlVHlwZSA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICB0aGlzLmltZyA9IG5ldyBJbWFnZSgpO1xyXG5cclxuICAgIHRoaXMuaW1nLm9ubG9hZCA9ICgpID0+IHtcclxuXHJcbiAgICAgIHRoaXMuaW1hZ2UgPSBuZXcgS29udmEuSW1hZ2Uoe1xyXG4gICAgICAgIGltYWdlOiB0aGlzLmltZyxcclxuICAgICAgfSk7XHJcblxyXG4gICAgICB0aGlzLmluaXRhbGl6ZVN0YWdlKCk7XHJcblxyXG4gICAgICB0aGlzLmxheWVyID0gbmV3IEtvbnZhLkxheWVyKHtcclxuICAgICAgfSk7XHJcbiAgICAgIHRoaXMubGF5ZXIuYWRkKHRoaXMuaW1hZ2UpO1xyXG4gICAgICB0aGlzLnN0YWdlLmFkZCh0aGlzLmxheWVyKTtcclxuXHJcbiAgICB9O1xyXG5cclxuICAgIHRoaXMuaW1nLnNyYyA9IFwiaHR0cHM6Ly9zaGFyZXBvaW50cHJvLmdpdGh1Yi5pby9zcHByby1pbWFnZS1hbm5vdGUvc3RhdGljL21lZGlhL3Jvb20uZmRjNWE4NjguanBnXCI7XHJcbiAgfVxyXG5cclxuXHJcbiAgaW5pdGFsaXplU3RhZ2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0YWdlID0gbmV3IEtvbnZhLlN0YWdlKHtcclxuICAgICAgY29udGFpbmVyOiBcInN0YWdlXCIsXHJcbiAgICAgIHdpZHRoOiB0aGlzLmltZy53aWR0aCxcclxuICAgICAgaGVpZ2h0OiB0aGlzLmltZy5oZWlnaHRcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuc3RhZ2Uub24oJ21vdXNlZG93bicsIChlKSA9PiB7IHRoaXMub25Nb3VzZURvd24oZSkgfSk7XHJcbiAgICB0aGlzLnN0YWdlLm9uKCdtb3VzZXVwJywgKGUpID0+IHsgdGhpcy5vbk1vdXNlVXAoZSkgfSk7XHJcbiAgICB0aGlzLnN0YWdlLm9uKCdtb3VzZW1vdmUnLCAoZSkgPT4geyB0aGlzLm9uTW91c2VNb3ZlKGUpIH0pO1xyXG4gIH1cclxuXHJcbiAgb25Nb3VzZURvd24oZSk6IHZvaWQge1xyXG4gICAgdGhpcy5pc1BhaW50ID0gdHJ1ZTtcclxuXHJcbiAgICB2YXIgcG9zID0gdGhpcy5zdGFnZS5nZXRQb2ludGVyUG9zaXRpb24oKTtcclxuXHJcbiAgICBpZiAodGhpcy5kcmF3YWJsZVR5cGUgPT09IERyYXdhYmxlRW51bS5GcmVlUGF0aERyYXdhYmxlKSB7XHJcbiAgICAgIHRoaXMubGFzdFNoYXBlID0gc2hhcGVGYWN0b3J5LkNyZWF0ZUxpbmUocG9zLngsIHBvcy55LCB0aGlzLmNvbG9yKTtcclxuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLlNxdWFyZURyYXdhYmxlKSB7XHJcbiAgICAgIHRoaXMubGFzdFNoYXBlID0gc2hhcGVGYWN0b3J5LkNyZWF0ZVJlY3RhbmdlKHBvcy54LCBwb3MueSwgdGhpcy5jb2xvcik7XHJcbiAgICAgIHRoaXMubGF5ZXIuYWRkKHRoaXMubGFzdFNoYXBlKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5kcmF3YWJsZVR5cGUgPT09IERyYXdhYmxlRW51bS5DaXJjbGVEcmF3YWJsZSkge1xyXG4gICAgICB0aGlzLmxhc3RTaGFwZSA9IHNoYXBlRmFjdG9yeS5DcmVhdGVDaXJjbGUocG9zLngsIHBvcy55LCB0aGlzLmNvbG9yKTtcclxuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLkFycm93RHJhd2FibGUpIHtcclxuICAgICAgdGhpcy5sYXN0U2hhcGUgPSBzaGFwZUZhY3RvcnkuQ3JlYXRlQXJyb3cocG9zLngsIHBvcy55LCB0aGlzLmNvbG9yKTtcclxuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLlRleHREcmF3YWJsZSkge1xyXG5cclxuICAgICAgaWYgKCF0aGlzLnRleHRBcmVhVmlzaWJsZSkge1xyXG4gICAgICAgIHRoaXMudGV4dEFyZWFWaXNpYmxlID0gdHJ1ZTtcclxuXHJcbiAgICAgICAgdGV4dGFyZWFGYWN0b3J5LmNyZWF0ZVRleHRBcmVhKHBvcy54LCBwb3MueSwgdGhpcy5jb2xvciwgREVGQVVMVF9GT05UX0ZBTUlMWSwgKGVsZW1lbnQpID0+IHtcclxuICAgICAgICAgIGlmIChlbGVtZW50LnRhcmdldC52YWx1ZSAhPT0gXCJcIikge1xyXG4gICAgICAgICAgICB0aGlzLmxhc3RTaGFwZSA9IHNoYXBlRmFjdG9yeS5DcmVhdGVUZXh0KHBvcy54LCBwb3MueSwgdGhpcy5jb2xvciwgREVGQVVMVF9GT05UX0ZBTUlMWSwgZWxlbWVudC50YXJnZXQudmFsdWUpO1xyXG4gICAgICAgICAgICB0aGlzLmxheWVyLmFkZCh0aGlzLmxhc3RTaGFwZSk7XHJcbiAgICAgICAgICAgIHRoaXMubGF5ZXIuYmF0Y2hEcmF3KCk7XHJcbiAgICAgICAgICAgIHRoaXMudGV4dEFyZWFWaXNpYmxlID0gZmFsc2U7XHJcblxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH1cclxuXHJcbiAgICB9XHJcblxyXG4gIH1cclxuXHJcbiAgb25TYXZlQ2xpY2soKTogdm9pZCB7XHJcbiAgICB0aGlzLm9uU2F2ZS5lbWl0KHRoaXMuc3RhZ2UudG9EYXRhVVJMKCkpO1xyXG4gIH1cclxuXHJcbiAgb25DbGVhcigpOiB2b2lkIHtcclxuICAgIHdoaWxlICh0aGlzLmxheWVyLmNoaWxkcmVuLmxlbmd0aCA+IDEpe1xyXG4gICAgICB0aGlzLm9uVW5kbygpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5sYXllci5iYXRjaERyYXcoKTtcclxuICB9XHJcblxyXG4gIG9uTW91c2VVcChlKTogdm9pZCB7XHJcbiAgICB0aGlzLmlzUGFpbnQgPSBmYWxzZTtcclxuICAgIHRoaXMubGFzdFNoYXBlID0gbnVsbDtcclxuICB9XHJcblxyXG4gIG9uVW5kbygpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmxheWVyLmNoaWxkcmVuLmxlbmd0aCA+IDEpIHtcclxuICAgICAgdGhpcy5sYXllci5jaGlsZHJlbi5zcGxpY2UoLTEsIDEpO1xyXG4gICAgICB0aGlzLmxheWVyLmJhdGNoRHJhdygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgb25Nb3VzZU1vdmUoZSk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLmlzUGFpbnQgfHwgIXRoaXMubGFzdFNoYXBlIHx8IHRoaXMubGFzdFNoYXBlID09PSBEcmF3YWJsZUVudW0uVGV4dERyYXdhYmxlKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IHBvcyA9IHRoaXMuc3RhZ2UuZ2V0UG9pbnRlclBvc2l0aW9uKCk7XHJcblxyXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uRnJlZVBhdGhEcmF3YWJsZSkge1xyXG4gICAgICBsZXQgbmV3UG9pbnRzID0gdGhpcy5sYXN0U2hhcGUucG9pbnRzKCkuY29uY2F0KFtwb3MueCwgcG9zLnldKTtcclxuICAgICAgdGhpcy5sYXN0U2hhcGUucG9pbnRzKG5ld1BvaW50cyk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uU3F1YXJlRHJhd2FibGUpIHtcclxuICAgICAgY29uc3QgZHggPSAtKHRoaXMubGFzdFNoYXBlLmF0dHJzLnggLSBwb3MueCk7XHJcbiAgICAgIGNvbnN0IGR5ID0gLSh0aGlzLmxhc3RTaGFwZS5hdHRycy55IC0gcG9zLnkpO1xyXG5cclxuICAgICAgdGhpcy5sYXN0U2hhcGUuYXR0cnMud2lkdGggPSBkeDtcclxuICAgICAgdGhpcy5sYXN0U2hhcGUuYXR0cnMuaGVpZ2h0ID0gZHk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uQ2lyY2xlRHJhd2FibGUpIHtcclxuICAgICAgY29uc3QgZHggPSB0aGlzLmxhc3RTaGFwZS5hdHRycy54IC0gcG9zLng7XHJcbiAgICAgIGNvbnN0IGR5ID0gdGhpcy5sYXN0U2hhcGUuYXR0cnMueSAtIHBvcy55O1xyXG4gICAgICBjb25zdCByYWRpdXMgPSBNYXRoLnNxcnQoZHggKiBkeCArIGR5ICogZHkpO1xyXG4gICAgICB0aGlzLmxhc3RTaGFwZS5hdHRycy5yYWRpdXMgPSByYWRpdXM7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uQXJyb3dEcmF3YWJsZSkge1xyXG4gICAgICBsZXQgbmV3UG9pbnRzID0gW3RoaXMubGFzdFNoYXBlLmF0dHJzLnBvaW50c1swXSwgdGhpcy5sYXN0U2hhcGUuYXR0cnMucG9pbnRzWzFdXTtcclxuXHJcbiAgICAgIG5ld1BvaW50cy5wdXNoKHBvcy54KTtcclxuICAgICAgbmV3UG9pbnRzLnB1c2gocG9zLnkpO1xyXG5cclxuICAgICAgdGhpcy5sYXN0U2hhcGUucG9pbnRzKG5ld1BvaW50cyk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5sYXllci5iYXRjaERyYXcoKTtcclxuICB9XHJcblxyXG5cclxufVxyXG4iXX0=