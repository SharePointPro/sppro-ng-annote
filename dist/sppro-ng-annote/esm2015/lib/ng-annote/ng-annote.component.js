import { Component, EventEmitter, Output } from '@angular/core';
import Konva from 'konva';
import { DrawableEnum } from '../enums/drawableEnum';
import shapeFactory from '../factories/shapeFactory';
import textareaFactory from '../factories/textareaFactory';
const DEFAULT_DRAWABLE_TYPE = DrawableEnum.FreePathDrawable;
const DEFAULT_FONT_FAMILY = 'Arial';
export class NgAnnoteComponent {
    constructor() {
        this.onSave = new EventEmitter();
        this._drawableType = DEFAULT_DRAWABLE_TYPE;
        this.isPaint = false;
        this.mode = 'brush';
        this.color = '#000000';
        this.textAreaVisible = false;
    }
    get drawableType() {
        return this._drawableType;
    }
    set drawableType(value) {
        this._drawableType = value;
    }
    ngOnInit() {
        this.img = new Image();
        this.img.onload = () => {
            this.image = new Konva.Image({
                image: this.img,
            });
            this.initalizeStage();
            this.layer = new Konva.Layer({});
            this.layer.add(this.image);
            this.stage.add(this.layer);
        };
        this.img.src = "https://sharepointpro.github.io/sppro-image-annote/static/media/room.fdc5a868.jpg";
    }
    initalizeStage() {
        this.stage = new Konva.Stage({
            container: "stage",
            width: this.img.width,
            height: this.img.height
        });
        this.stage.on('mousedown', (e) => { this.onMouseDown(e); });
        this.stage.on('mouseup', (e) => { this.onMouseUp(e); });
        this.stage.on('mousemove', (e) => { this.onMouseMove(e); });
    }
    onMouseDown(e) {
        this.isPaint = true;
        var pos = this.stage.getPointerPosition();
        if (this.drawableType === DrawableEnum.FreePathDrawable) {
            this.lastShape = shapeFactory.CreateLine(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.SquareDrawable) {
            this.lastShape = shapeFactory.CreateRectange(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.CircleDrawable) {
            this.lastShape = shapeFactory.CreateCircle(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.ArrowDrawable) {
            this.lastShape = shapeFactory.CreateArrow(pos.x, pos.y, this.color);
            this.layer.add(this.lastShape);
        }
        if (this.drawableType === DrawableEnum.TextDrawable) {
            if (!this.textAreaVisible) {
                this.textAreaVisible = true;
                textareaFactory.createTextArea(pos.x, pos.y, this.color, DEFAULT_FONT_FAMILY, (element) => {
                    if (element.target.value !== "") {
                        this.lastShape = shapeFactory.CreateText(pos.x, pos.y, this.color, DEFAULT_FONT_FAMILY, element.target.value);
                        this.layer.add(this.lastShape);
                        this.layer.batchDraw();
                        this.textAreaVisible = false;
                    }
                });
            }
        }
    }
    onSaveClick() {
        this.onSave.emit(this.stage.toDataURL());
    }
    onClear() {
        while (this.layer.children.length > 1) {
            this.onUndo();
        }
        this.layer.batchDraw();
    }
    onMouseUp(e) {
        this.isPaint = false;
        this.lastShape = null;
    }
    onUndo() {
        if (this.layer.children.length > 1) {
            this.layer.children.splice(-1, 1);
            this.layer.batchDraw();
        }
    }
    onMouseMove(e) {
        if (!this.isPaint || !this.lastShape || this.lastShape === DrawableEnum.TextDrawable) {
            return;
        }
        const pos = this.stage.getPointerPosition();
        if (this.drawableType === DrawableEnum.FreePathDrawable) {
            let newPoints = this.lastShape.points().concat([pos.x, pos.y]);
            this.lastShape.points(newPoints);
        }
        if (this.drawableType === DrawableEnum.SquareDrawable) {
            const dx = -(this.lastShape.attrs.x - pos.x);
            const dy = -(this.lastShape.attrs.y - pos.y);
            this.lastShape.attrs.width = dx;
            this.lastShape.attrs.height = dy;
        }
        if (this.drawableType === DrawableEnum.CircleDrawable) {
            const dx = this.lastShape.attrs.x - pos.x;
            const dy = this.lastShape.attrs.y - pos.y;
            const radius = Math.sqrt(dx * dx + dy * dy);
            this.lastShape.attrs.radius = radius;
        }
        if (this.drawableType === DrawableEnum.ArrowDrawable) {
            let newPoints = [this.lastShape.attrs.points[0], this.lastShape.attrs.points[1]];
            newPoints.push(pos.x);
            newPoints.push(pos.y);
            this.lastShape.points(newPoints);
        }
        this.layer.batchDraw();
    }
}
NgAnnoteComponent.decorators = [
    { type: Component, args: [{
                selector: 'sppro-ng-annote',
                template: "<div class='overlay sppro-overlay'>\n    <sppro-toolbar [(drawableType)]=\"drawableType\" [(color)]=\"color\" (onUndo)=\"onUndo()\" (onClear)=\"onClear()\" (onSave)=\"onSaveClick()\"></sppro-toolbar>\n    <div class=\"centeredBox\">\n        <div id=\"stage\">\n            \n        </div>\n    </div>\n\n</div>",
                styles: [".centeredBox{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%)}.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background-color:rgba(0,0,0,.6);z-index:1000}.closeButton{position:fixed;right:15px;top:15px;cursor:pointer}.crosshair{cursor:crosshair}.text{cursor:text}"]
            },] }
];
NgAnnoteComponent.ctorParameters = () => [];
NgAnnoteComponent.propDecorators = {
    onSave: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctYW5ub3RlLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3NwcHJvLW5nLWFubm90ZS9zcmMvbGliL25nLWFubm90ZS9uZy1hbm5vdGUuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFVLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN4RSxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFDMUIsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFPLHVCQUF1QixDQUFDO0FBQ3RELE9BQU8sWUFBWSxNQUFNLDJCQUEyQixDQUFDO0FBQ3JELE9BQU8sZUFBZSxNQUFNLDhCQUE4QixDQUFDO0FBRTNELE1BQU0scUJBQXFCLEdBQWlCLFlBQVksQ0FBQyxnQkFBZ0IsQ0FBQztBQUMxRSxNQUFNLG1CQUFtQixHQUFXLE9BQU8sQ0FBQztBQU81QyxNQUFNLE9BQU8saUJBQWlCO0lBa0I1QjtRQWhCVSxXQUFNLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUV0QyxrQkFBYSxHQUFpQixxQkFBcUIsQ0FBQztRQUs1RCxZQUFPLEdBQVksS0FBSyxDQUFDO1FBQ3pCLFNBQUksR0FBVyxPQUFPLENBQUM7UUFFdkIsVUFBSyxHQUFXLFNBQVMsQ0FBQztRQUMxQixvQkFBZSxHQUFZLEtBQUssQ0FBQztJQU9qQyxDQUFDO0lBR0QsSUFBSSxZQUFZO1FBQ2QsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDO0lBQzVCLENBQUM7SUFFRCxJQUFJLFlBQVksQ0FBQyxLQUFtQjtRQUNsQyxJQUFJLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQztJQUM3QixDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUV2QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7WUFFckIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQzNCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRzthQUNoQixDQUFDLENBQUM7WUFFSCxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFFdEIsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFDNUIsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQzNCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUU3QixDQUFDLENBQUM7UUFFRixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsR0FBRyxtRkFBbUYsQ0FBQztJQUNyRyxDQUFDO0lBR0QsY0FBYztRQUNaLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDO1lBQzNCLFNBQVMsRUFBRSxPQUFPO1lBQ2xCLEtBQUssRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUs7WUFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTTtTQUN4QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzRCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2RCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsV0FBVyxDQUFDLENBQUM7UUFDWCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUVwQixJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFMUMsSUFBSSxJQUFJLENBQUMsWUFBWSxLQUFLLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRTtZQUN2RCxJQUFJLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNuRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUFDLGNBQWMsRUFBRTtZQUNyRCxJQUFJLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUFDLGNBQWMsRUFBRTtZQUNyRCxJQUFJLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNyRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUFDLGFBQWEsRUFBRTtZQUNwRCxJQUFJLENBQUMsU0FBUyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNwRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDaEM7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUFDLFlBQVksRUFBRTtZQUVuRCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRTtnQkFDekIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBRTVCLGVBQWUsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsRUFBRTtvQkFDeEYsSUFBSSxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssS0FBSyxFQUFFLEVBQUU7d0JBQy9CLElBQUksQ0FBQyxTQUFTLEdBQUcsWUFBWSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxtQkFBbUIsRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUM5RyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7d0JBQy9CLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7d0JBQ3ZCLElBQUksQ0FBQyxlQUFlLEdBQUcsS0FBSyxDQUFDO3FCQUU5QjtnQkFDSCxDQUFDLENBQUMsQ0FBQTthQUNIO1NBRUY7SUFFSCxDQUFDO0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBQztZQUNwQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDZjtRQUNELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELFNBQVMsQ0FBQyxDQUFDO1FBQ1QsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUU7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDeEI7SUFDSCxDQUFDO0lBRUQsV0FBVyxDQUFDLENBQUM7UUFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsS0FBSyxZQUFZLENBQUMsWUFBWSxFQUFFO1lBQ3BGLE9BQU87U0FDUjtRQUNELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUU1QyxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssWUFBWSxDQUFDLGdCQUFnQixFQUFFO1lBQ3ZELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvRCxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUNsQztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsY0FBYyxFQUFFO1lBQ3JELE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRTdDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDaEMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztTQUNsQztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsY0FBYyxFQUFFO1lBQ3JELE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzFDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDNUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztTQUN0QztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksS0FBSyxZQUFZLENBQUMsYUFBYSxFQUFFO1lBQ3BELElBQUksU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWpGLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXRCLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUN6QixDQUFDOzs7WUE5S0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxpQkFBaUI7Z0JBQzNCLG9VQUF5Qzs7YUFFMUM7Ozs7cUJBR0UsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZU9mZmxpbmVDb21waWxlVXJsUmVzb2x2ZXIgfSBmcm9tICdAYW5ndWxhci9jb21waWxlcic7XG5pbXBvcnQgeyBDb21wb25lbnQsIEV2ZW50RW1pdHRlciwgT25Jbml0LCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCBLb252YSBmcm9tICdrb252YSc7XG5pbXBvcnQgeyBEcmF3YWJsZUVudW0gfSBmcm9tICAnLi4vZW51bXMvZHJhd2FibGVFbnVtJztcbmltcG9ydCBzaGFwZUZhY3RvcnkgZnJvbSAnLi4vZmFjdG9yaWVzL3NoYXBlRmFjdG9yeSc7XG5pbXBvcnQgdGV4dGFyZWFGYWN0b3J5IGZyb20gJy4uL2ZhY3Rvcmllcy90ZXh0YXJlYUZhY3RvcnknO1xuXG5jb25zdCBERUZBVUxUX0RSQVdBQkxFX1RZUEU6IERyYXdhYmxlRW51bSA9IERyYXdhYmxlRW51bS5GcmVlUGF0aERyYXdhYmxlO1xuY29uc3QgREVGQVVMVF9GT05UX0ZBTUlMWTogc3RyaW5nID0gJ0FyaWFsJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnc3Bwcm8tbmctYW5ub3RlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL25nLWFubm90ZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL25nLWFubm90ZS5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIE5nQW5ub3RlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICBAT3V0cHV0KCkgb25TYXZlID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmc+KCk7XG5cbiAgcHJpdmF0ZSBfZHJhd2FibGVUeXBlOiBEcmF3YWJsZUVudW0gPSBERUZBVUxUX0RSQVdBQkxFX1RZUEU7XG5cbiAgc3RhZ2U6IEtvbnZhLlN0YWdlO1xuICBsYXllcjogS29udmEuTGF5ZXI7XG4gIGltYWdlOiBLb252YS5JbWFnZTtcbiAgaXNQYWludDogYm9vbGVhbiA9IGZhbHNlO1xuICBtb2RlOiBzdHJpbmcgPSAnYnJ1c2gnO1xuICBsYXN0U2hhcGU6IGFueTtcbiAgY29sb3I6IHN0cmluZyA9ICcjMDAwMDAwJztcbiAgdGV4dEFyZWFWaXNpYmxlOiBib29sZWFuID0gZmFsc2U7XG5cblxuICBpbWc6IEhUTUxJbWFnZUVsZW1lbnQ7XG5cbiAgY29uc3RydWN0b3IoKSB7XG5cbiAgfVxuXG5cbiAgZ2V0IGRyYXdhYmxlVHlwZSgpOiBEcmF3YWJsZUVudW0ge1xuICAgIHJldHVybiB0aGlzLl9kcmF3YWJsZVR5cGU7XG4gIH1cblxuICBzZXQgZHJhd2FibGVUeXBlKHZhbHVlOiBEcmF3YWJsZUVudW0pIHtcbiAgICB0aGlzLl9kcmF3YWJsZVR5cGUgPSB2YWx1ZTtcbiAgfVxuXG4gIG5nT25Jbml0KCk6IHZvaWQge1xuICAgIHRoaXMuaW1nID0gbmV3IEltYWdlKCk7XG5cbiAgICB0aGlzLmltZy5vbmxvYWQgPSAoKSA9PiB7XG5cbiAgICAgIHRoaXMuaW1hZ2UgPSBuZXcgS29udmEuSW1hZ2Uoe1xuICAgICAgICBpbWFnZTogdGhpcy5pbWcsXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5pbml0YWxpemVTdGFnZSgpO1xuXG4gICAgICB0aGlzLmxheWVyID0gbmV3IEtvbnZhLkxheWVyKHtcbiAgICAgIH0pO1xuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5pbWFnZSk7XG4gICAgICB0aGlzLnN0YWdlLmFkZCh0aGlzLmxheWVyKTtcblxuICAgIH07XG5cbiAgICB0aGlzLmltZy5zcmMgPSBcImh0dHBzOi8vc2hhcmVwb2ludHByby5naXRodWIuaW8vc3Bwcm8taW1hZ2UtYW5ub3RlL3N0YXRpYy9tZWRpYS9yb29tLmZkYzVhODY4LmpwZ1wiO1xuICB9XG5cblxuICBpbml0YWxpemVTdGFnZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0YWdlID0gbmV3IEtvbnZhLlN0YWdlKHtcbiAgICAgIGNvbnRhaW5lcjogXCJzdGFnZVwiLFxuICAgICAgd2lkdGg6IHRoaXMuaW1nLndpZHRoLFxuICAgICAgaGVpZ2h0OiB0aGlzLmltZy5oZWlnaHRcbiAgICB9KTtcblxuICAgIHRoaXMuc3RhZ2Uub24oJ21vdXNlZG93bicsIChlKSA9PiB7IHRoaXMub25Nb3VzZURvd24oZSkgfSk7XG4gICAgdGhpcy5zdGFnZS5vbignbW91c2V1cCcsIChlKSA9PiB7IHRoaXMub25Nb3VzZVVwKGUpIH0pO1xuICAgIHRoaXMuc3RhZ2Uub24oJ21vdXNlbW92ZScsIChlKSA9PiB7IHRoaXMub25Nb3VzZU1vdmUoZSkgfSk7XG4gIH1cblxuICBvbk1vdXNlRG93bihlKTogdm9pZCB7XG4gICAgdGhpcy5pc1BhaW50ID0gdHJ1ZTtcblxuICAgIHZhciBwb3MgPSB0aGlzLnN0YWdlLmdldFBvaW50ZXJQb3NpdGlvbigpO1xuXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uRnJlZVBhdGhEcmF3YWJsZSkge1xuICAgICAgdGhpcy5sYXN0U2hhcGUgPSBzaGFwZUZhY3RvcnkuQ3JlYXRlTGluZShwb3MueCwgcG9zLnksIHRoaXMuY29sb3IpO1xuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLlNxdWFyZURyYXdhYmxlKSB7XG4gICAgICB0aGlzLmxhc3RTaGFwZSA9IHNoYXBlRmFjdG9yeS5DcmVhdGVSZWN0YW5nZShwb3MueCwgcG9zLnksIHRoaXMuY29sb3IpO1xuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLkNpcmNsZURyYXdhYmxlKSB7XG4gICAgICB0aGlzLmxhc3RTaGFwZSA9IHNoYXBlRmFjdG9yeS5DcmVhdGVDaXJjbGUocG9zLngsIHBvcy55LCB0aGlzLmNvbG9yKTtcbiAgICAgIHRoaXMubGF5ZXIuYWRkKHRoaXMubGFzdFNoYXBlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kcmF3YWJsZVR5cGUgPT09IERyYXdhYmxlRW51bS5BcnJvd0RyYXdhYmxlKSB7XG4gICAgICB0aGlzLmxhc3RTaGFwZSA9IHNoYXBlRmFjdG9yeS5DcmVhdGVBcnJvdyhwb3MueCwgcG9zLnksIHRoaXMuY29sb3IpO1xuICAgICAgdGhpcy5sYXllci5hZGQodGhpcy5sYXN0U2hhcGUpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLlRleHREcmF3YWJsZSkge1xuXG4gICAgICBpZiAoIXRoaXMudGV4dEFyZWFWaXNpYmxlKSB7XG4gICAgICAgIHRoaXMudGV4dEFyZWFWaXNpYmxlID0gdHJ1ZTtcblxuICAgICAgICB0ZXh0YXJlYUZhY3RvcnkuY3JlYXRlVGV4dEFyZWEocG9zLngsIHBvcy55LCB0aGlzLmNvbG9yLCBERUZBVUxUX0ZPTlRfRkFNSUxZLCAoZWxlbWVudCkgPT4ge1xuICAgICAgICAgIGlmIChlbGVtZW50LnRhcmdldC52YWx1ZSAhPT0gXCJcIikge1xuICAgICAgICAgICAgdGhpcy5sYXN0U2hhcGUgPSBzaGFwZUZhY3RvcnkuQ3JlYXRlVGV4dChwb3MueCwgcG9zLnksIHRoaXMuY29sb3IsIERFRkFVTFRfRk9OVF9GQU1JTFksIGVsZW1lbnQudGFyZ2V0LnZhbHVlKTtcbiAgICAgICAgICAgIHRoaXMubGF5ZXIuYWRkKHRoaXMubGFzdFNoYXBlKTtcbiAgICAgICAgICAgIHRoaXMubGF5ZXIuYmF0Y2hEcmF3KCk7XG4gICAgICAgICAgICB0aGlzLnRleHRBcmVhVmlzaWJsZSA9IGZhbHNlO1xuXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgfVxuXG4gICAgfVxuXG4gIH1cblxuICBvblNhdmVDbGljaygpOiB2b2lkIHtcbiAgICB0aGlzLm9uU2F2ZS5lbWl0KHRoaXMuc3RhZ2UudG9EYXRhVVJMKCkpO1xuICB9XG5cbiAgb25DbGVhcigpOiB2b2lkIHtcbiAgICB3aGlsZSAodGhpcy5sYXllci5jaGlsZHJlbi5sZW5ndGggPiAxKXtcbiAgICAgIHRoaXMub25VbmRvKCk7XG4gICAgfVxuICAgIHRoaXMubGF5ZXIuYmF0Y2hEcmF3KCk7XG4gIH1cblxuICBvbk1vdXNlVXAoZSk6IHZvaWQge1xuICAgIHRoaXMuaXNQYWludCA9IGZhbHNlO1xuICAgIHRoaXMubGFzdFNoYXBlID0gbnVsbDtcbiAgfVxuXG4gIG9uVW5kbygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5sYXllci5jaGlsZHJlbi5sZW5ndGggPiAxKSB7XG4gICAgICB0aGlzLmxheWVyLmNoaWxkcmVuLnNwbGljZSgtMSwgMSk7XG4gICAgICB0aGlzLmxheWVyLmJhdGNoRHJhdygpO1xuICAgIH1cbiAgfVxuXG4gIG9uTW91c2VNb3ZlKGUpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuaXNQYWludCB8fCAhdGhpcy5sYXN0U2hhcGUgfHwgdGhpcy5sYXN0U2hhcGUgPT09IERyYXdhYmxlRW51bS5UZXh0RHJhd2FibGUpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgcG9zID0gdGhpcy5zdGFnZS5nZXRQb2ludGVyUG9zaXRpb24oKTtcblxuICAgIGlmICh0aGlzLmRyYXdhYmxlVHlwZSA9PT0gRHJhd2FibGVFbnVtLkZyZWVQYXRoRHJhd2FibGUpIHtcbiAgICAgIGxldCBuZXdQb2ludHMgPSB0aGlzLmxhc3RTaGFwZS5wb2ludHMoKS5jb25jYXQoW3Bvcy54LCBwb3MueV0pO1xuICAgICAgdGhpcy5sYXN0U2hhcGUucG9pbnRzKG5ld1BvaW50cyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uU3F1YXJlRHJhd2FibGUpIHtcbiAgICAgIGNvbnN0IGR4ID0gLSh0aGlzLmxhc3RTaGFwZS5hdHRycy54IC0gcG9zLngpO1xuICAgICAgY29uc3QgZHkgPSAtKHRoaXMubGFzdFNoYXBlLmF0dHJzLnkgLSBwb3MueSk7XG5cbiAgICAgIHRoaXMubGFzdFNoYXBlLmF0dHJzLndpZHRoID0gZHg7XG4gICAgICB0aGlzLmxhc3RTaGFwZS5hdHRycy5oZWlnaHQgPSBkeTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kcmF3YWJsZVR5cGUgPT09IERyYXdhYmxlRW51bS5DaXJjbGVEcmF3YWJsZSkge1xuICAgICAgY29uc3QgZHggPSB0aGlzLmxhc3RTaGFwZS5hdHRycy54IC0gcG9zLng7XG4gICAgICBjb25zdCBkeSA9IHRoaXMubGFzdFNoYXBlLmF0dHJzLnkgLSBwb3MueTtcbiAgICAgIGNvbnN0IHJhZGl1cyA9IE1hdGguc3FydChkeCAqIGR4ICsgZHkgKiBkeSk7XG4gICAgICB0aGlzLmxhc3RTaGFwZS5hdHRycy5yYWRpdXMgPSByYWRpdXM7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZHJhd2FibGVUeXBlID09PSBEcmF3YWJsZUVudW0uQXJyb3dEcmF3YWJsZSkge1xuICAgICAgbGV0IG5ld1BvaW50cyA9IFt0aGlzLmxhc3RTaGFwZS5hdHRycy5wb2ludHNbMF0sIHRoaXMubGFzdFNoYXBlLmF0dHJzLnBvaW50c1sxXV07XG5cbiAgICAgIG5ld1BvaW50cy5wdXNoKHBvcy54KTtcbiAgICAgIG5ld1BvaW50cy5wdXNoKHBvcy55KTtcblxuICAgICAgdGhpcy5sYXN0U2hhcGUucG9pbnRzKG5ld1BvaW50cyk7XG4gICAgfVxuXG4gICAgdGhpcy5sYXllci5iYXRjaERyYXcoKTtcbiAgfVxuXG5cbn1cbiJdfQ==